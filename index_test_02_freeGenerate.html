<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8">
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#333333">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>中联兴环保项目</title>
    <!--网页标签前的shortCut logo,如有特殊需求，中联兴公司可自行定制-->
    <link rel="shortcut icon" href="./images/logo.png">
    <link href="./css/font-awesome.min.css" rel="stylesheet">
    <link href="./Cesium/Release/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/navigation-mixin.css" rel="stylesheet">
    <!--<script src="./js/libs/require.js" data-main="./js/main.js"></script>-->
    <!--<script src="./js/libs/require.js" ></script>-->
    <!--<script src="./Cesium/Release/CesiumUn/Cesium.js" ></script>-->
    <script src="./js/libs/jquery.js" ></script>
    <script src="./js/PositionPick.js"></script>
    <script src="./js/navigation-mixin.js" ></script>


    <!--By SUN Peifeng-->
    <!--我注释了一些你的alert，记得恢复过来-->
    <link rel="stylesheet" href="css/toolBars.css"/>
    <link rel="stylesheet" href="css/reset.css"/>
    <link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/modal.css"/>
    <link rel="stylesheet" href="css/jquery-ui.min.css"/>
    <!-- Json2html -->
    <script src="./js/json2html.js"></script>
    <script src="./js/jquery.json2html.js"></script>
    <!--DateTimePicker-->
    <script src="./js/jquery.datetimepicker.full.js"></script>
    <script src="./js/jquery.mousewheel.js"></script>
    <script src="js/php-date-formatter.js"></script>
    <link rel="stylesheet" href="css/jquery.datetimepicker.css">
    <!--BootStrap-->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script text="text/javascript" src="./js/pinying.js" charset="GBK"></script>
    <link rel="stylesheet" href="css/style.css"/>

    <!--ends here By SUN Peifeng-->

</head>
<body>
    <div id="allContainer">
        <div id="left-side-nav-panel" class="leftSideNav">
            <!--sidebar-->
            <div class="sidebar panel panel-default" id="sidebar">

            </div>
        </div>
        <div id="cesiumContainer">
            <div id = "test">
            </div>
            <div id="tool-bar-append" ></div>
            <div id="position" ></div>
        </div>

    </div>
    <script>
        var jsonData;
        loadJSON(function (response) {
            // Parse JSON string into object
            jsonData = JSON.parse(response);
            var park, site, instrument, factor;
            for (park in jsonData) {
                for (site in jsonData[park]["sites"]) {
                    for (instrument in jsonData[park]["sites"][site]["instrument"]) {
                        for (factor in jsonData[park]["sites"][site]["instrument"][instrument]["factor"]) {
                            jsonData[park]["sites"][site]["instrument"][instrument]["factor"].sort(function(a,b){
                                return a["name"].localeCompare(b["name"], 'zh-Hans-CN', {sensitivity: 'accent'});
                            });
                        }
                    }
                }
            }
        });
        function loadJSON(callback) {
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'ParkStructure.json', true); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    callback(xobj.responseText);
                }
            };
            xobj.send(null);
        }
        //List item transform
        var transform = {
            "park":[{"<>":"div","class":"panel-heading",
                "html":[{"<>":"h4","class":"panel-title",
                    "html":[{"<>":"a","data-toggle":"collapse","href":"#collapse-${parkId}","html":"${name}"}]
                }]
            },
                {"<>":"div","class":"sidebar-info panel-collapse collapse", "id":"collapse-${parkId}",
                "html": [{"<>":"div", "class":"panel-body", "html":function (){
                    var side_li_content = "<ul class=\"side-li\">";
                    var side_li_html = json2html.transform(this.sites,transform.siteLi);
                    side_li_html += "</ul>";
                    var parkId = this.parkId;
                    var hidenboxIdString = 'hiden-box'+parkId;
                    var hiden_box_content = "<ul class=\"hiden-box\">";
                    var hiden_box_html = json2html.transform(this.sites,transform.siteHiddenBox);
                    hiden_box_html += "</ul>";
                    return (side_li_content+side_li_html+hiden_box_content+hiden_box_html);
                }}]
            }],
            "siteLi":{"<>":"li", "class":"s_${siteId}",
                    "html":[{"<>":"h3", "siteId":"${siteId}",
                        "html":"${name}<span class=\"rightArrow rightArrow-angle-right rightArrow-loc\"></span>"
                    }]
            },
            "siteHiddenBox":[{
                "<>":"li","data-hidden":"li","id":"hiden-${siteId}","html":[
                    {"<>":"div", "class":"sub-nav-right","html":function () {
                        return json2html.transform(this.instrument,transform.sub_nav);
                    }}
                ]
            }],
            "sub_nav":[
                {"<>":"div","class":"cell-box","html":function () {
                    return json2html.transform(this,transform.cell_box);
                    }
                }],
            "cell_box":[{
                "<>":"h1","instrumentId":"${instrumentId}","html":"${name}"},{
                "<>":"div","class":"a-box","html":function () {
                    return json2html.transform(this.factor,transform.a_box);
                }
            }],
            "a_box":[{
                "<>":"button","href":"#1", "class":"factor","factorId":"${factorId}", "html":"${name}"
            },{
                "<>":"span","html":" "
            }]
        };

        var selectedFactorsInfo;
        selectedFactorsInfo = [];
        $(function(){
            //Create the list
            $('#sidebar').json2html(jsonData,transform.park);
            leftSideBarConf();
            $('<div style="position: fixed;bottom: 0; width: 25%; height:25%; background-color:#0D1C32; z-index: 9999;"><div class="datetimePickerDiv"><label>起始时间：</label><input id="startDateTimepicker" class="datetimepicker" type="text"><label>截止时间：</label><input id="endDateTimepicker" class="datetimepicker" type="text"></div><div class="submitAndFavButton"><button class="submitButton">提交</button></div></div>').appendTo('#left-side-nav-panel');

            jQuery(function(){
                jQuery('#startDateTimepicker').datetimepicker({
                    format:'Y-m-d H:i',
                    lang: 'ch',
                    onShow:function( ct ){
                    this.setOptions({
                                    maxDate: jQuery('#endDateTimepicker').val() ? jQuery('#endDateTimepicker').val() : false
                                })
                    },
                    timepicker: true
                });

                jQuery('#endDateTimepicker').datetimepicker({
                    format: 'Y-m-d H:i',
                    locale: 'ch',
                    onShow: function (ct) {
                        this.setOptions({
                            minDate: jQuery('#startDateTimepicker').val() ? jQuery('#startDateTimepicker').val() : false
                        })
                    },
                    timepicker: true
                });
            });
            jQuery.datetimepicker.setLocale('ch');

        
            $('.factor').click( function(e) {

                var factorid = $(this).attr("factorid");
                var instrumentid = $(this).parent().prev().attr("instrumentid");
                var siteid = $(this).parent().parent().parent().parent().attr("id").split("-")[1];
                var parkid = $(this).parent().parent().parent().parent().parent().parent().parent().attr("id").split("-")[1];
//                console.log("factorid:" + factorid);
//                console.log("instrumentid:" + instrumentid);
//                console.log("siteid:" + siteid);
//                console.log("parkid:" + factorid);

                if ($(this).hasClass("selectedFactor")){
                    $(this).removeClass("selectedFactor");
                    var afterFilter = [];
                    afterFilter = $.grep(selectedFactorsInfo,function (obj) {
                        console.log(obj.instrumentid);
                        if ((obj.instrumentid === instrumentid) && (obj.factorid === factorid) && (obj.siteid === siteid) && (obj.parkid === parkid)) {
                            //Old factor, Remove
                            return false;
                        } else {
                            //New facotor, add
                            return true;
                        }
                    });
                    selectedFactorsInfo = afterFilter;
                } else {
                    $(this).addClass("selectedFactor");
                    var factorInfo = {"parkid":parkid,"siteid":siteid,"instrumentid":instrumentid,"factorid":factorid};
                    selectedFactorsInfo.push(factorInfo);
                }
                console.log("selectedFactorsInfo: "+selectedFactorsInfo);

            });
            $(".submitButton").click( function () {
                console.log("succvvvv");
                // $.post( "http://localhost:8000/", { "name": "John", "time": "2pm" } );
                var startDate = document.getElementById('startDateTimepicker').value;
                var endDate = document.getElementById('endDateTimepicker').value;
                generateDataToPost(startDate, endDate);
            })
            function generateDataToPost(startDate, endDate){
                var queryObj = {"factorsQuery":selectedFactorsInfo,"startDate":startDate,"endDate":endDate};
                var string = JSON.stringify(queryObj);
                console.log("jsonData:" + string);
            }
        });

    </script>
    <script>
        /*$(document).ready(function(){

            $("#header-left-container").classList.toggle("changeButtonBackground");


        });
        */
        $(function(){
            $('<i />',{
                id:'home',
                "class":"fa fa-home",
                "aria-hidden":"true",
                "color":'#08ABD5',
                'background':'#888',
                "title":"首页",
                click:function(){

                    viewer.zoomTo(viewer.entities);
                }
            }).appendTo("#test");
        });

        $(function(){
            $('<i />',{
                id:'3D_2D',
                "class":"fa fa-globe",
                "aria-hidden":"true",
                "color":'#08ABD5',
                'background':'#888',
                "title":"2D/3D",
                click:function(){

                    if($(this).hasClass("fa-globe")){
                        $(this).removeClass("fa-globe");
                        $(this).addClass("fa-map-o");
                        alert("切换Cesium为2D");
                    }else{
                        $(this).removeClass("fa-map-o");
                        $(this).addClass("fa-globe");
                        alert("切换Cesium为3D");
                    }
                }
            }).appendTo("#test");

        });


        $(function(){
            $('<i />',{
                id:'dataPicker',
                "class":"fa fa-database",
                "aria-hidden":"true",
                "color":'#08ABD5',
                'background':'#888',
                "title":"数据加载",
                click:function(){

                    $("#TTT").draggable();

                    var html = " <input type=\"range\" min=\"-1\" max=\"1\" step=\"0.01\" data-bind=\"value: brightnessShift, valueUpdate: 'input'\">"

                    var html2 = "<table><tbody>\n" +
                        "                        <tr>\n" +
                        "                        <td><input type=\"checkbox\" data-bind=\"checked: show\"></td>\n" +
                        "                        <td>\n" +
                        "                        <span data-bind=\"text\": \"矢量切片数据\"></span>\n" +
                        "                    </td>\n" +
                        "                    </tr>\n" +
                        "                    </tbody></table>"
                    $("#TTT").append(html2);

                }
            }).appendTo("#test");
        });

        $(function(){
            $("<input />",{
                id:'toolbarsCheckbox',
                "class":"toolbarsDis",
                "type":"checkbox",
                "z-index": "3000"
            }).appendTo("#test");
        });
        $(function(){
            $("<label />",{
                id:'toolbarsLabel',
                "for":"toolbarsCheckbox",
                "class": "fa fa-wrench",
                "display":"block",
                "aria-hidden": "true",
                "color": '#08ABD5',
                'background': '#888',
                "title": "工具集",
                "z-index": "2000"
            }).appendTo("#test");
        });


        $(function(){

            $('<i />',{
                id:'roamHelper',
                "class":"fa fa-plane buttonMove roamAnimation",
                "aria-hidden":"true",
                "color":'#08ABD5',
                'background':'#888',
                "title":"三维巡航",
                click:function(){

                    alert("ok");
                }
            }).appendTo("#test");
        });
        /*********************************绘图工具********************************/
        $(function(){
            $('<i />',{
                id:'drawHelper',
                "class":"fa fa-pencil buttonMove drawAnimation",
                "aria-hidden":"true",
                "color":'#08ABD5',
                'background':'#888',
                "title":"绘图工具",
                click:function(){
                    if($(this).hasClass("active")){
                        $("#drawToolsContainer").hide();
                        $(this).removeClass("active");

                    }else{
                        $("#drawToolsContainer").show();
                        $(this).addClass("active");
                    }


                }
            }).appendTo("#test");
        });
        $('<div />',{
            id:'drawToolsContainer',
            "class":"drawToolsContainer toolsContainerDis"
        }).appendTo("#cesiumContainer");

        $('<i />',{
            id:'delectPoly',
            "class":"fa fa-trash toolsContainer",
            "aria-hidden":"true",
            "color":'#08ABD5',
            'background':'#888',
            "title":"删除",
            click:function(){
                alert("删除");
            }
        }).appendTo("#drawToolsContainer");

        $('<i />',{
            id:'drawPolygon',
            "class":"fa fa-marker toolsContainer",
            "aria-hidden":"true",
            "color":'#08ABD5',
            'background':'#888',
            "title":"绘制多边形",
            click:function(){
                alert("绘制多边形");
            }
        }).appendTo("#drawToolsContainer");

        $('<i />',{
            id:'drawExtent',
            "class":"fa fa-marker toolsContainer",
            "aria-hidden":"true",
            "color":'#08ABD5',
            'background':'#888',
            "title":"绘制多方形",
            click:function(){
                alert("绘制方形");
            }
        }).appendTo("#drawToolsContainer");



        $('<i />',{
            id:'drawPolyline',
            "class":"fa fa-marker toolsContainer",
            "aria-hidden":"true",
            "color":'#08ABD5',
            'background':'#888',
            "title":"绘制线",
            click:function(){
                alert("绘制线");
            }
        }).appendTo("#drawToolsContainer");

        $('<i />',{
            id:'drawPin',
            "class":"fa fa-map-marker toolsContainer",
            "aria-hidden":"true",
            "color":'#08ABD5',
            'background':'#888',
            "title":"图标",
            click:function(){
                alert("创建图标");
            }
        }).appendTo("#drawToolsContainer");


        /*******************************测量工具********************************/
        $(function(){
            $('<div />',{
                id:'measureHelper',
                "class":"fa fa-pencil buttonMove measureAnimation",
                "background-image":"url(images/measure.png)",
                "color":'#08ABD5',
                'background-color':'#888',
                "title":"测量工具",
                click:function(){

                    alert("ok");
                }
            }).appendTo("#test");
        });
        $(function(){

            $('<i />',{
                id:'statisticsHelper',
                "class":"fa fa-bar-chart buttonMove statAnimation",
                "aria-hidden":"true",
                "color":'#08ABD5',
                'background':'#888',
                "title":"统计工具",
                click:function(){

                    alert("ok");
                }
            }).appendTo("#test");
        });
        $(function(){
            $('<i />',{
                id:'situationMap',
                "class":"fa fa-cubes",
                "aria-hidden":"true",
                "color":'#08ABD5',
                'background':'#888',
                "title":"实时可视化层",
                click:function(){
                    if($(this).hasClass("fa-cubes")){
                        $(this).removeClass("fa-cubes");
                        $(this).addClass("fa-tasks");
                        $(this).attr("title","态势分析层");
                        alert("切换为态势分析层，执行heatMap以及态势标签显示");
                        viewer.entities.removeAll();
                        taiShiLegendDraw();
                        alert("OK");
                        //drawHeatMap();
                    }else if($(this).hasClass("fa-tasks")){
                        $(this).removeClass("fa-tasks");
                        $(this).addClass("fa-exclamation-triangle");
                        $(this).attr("title","诊断分析层");
                        alert("切换为诊断分析层");
                    }else{
                        $(this).removeClass("fa-exclamation-triangle");
                        $(this).addClass("fa-cubes");
                        $(this).attr("title","实时可视化层");

                    }
                }
            }).appendTo("#test");
        });

        $(function(){
            $('<i />',{
                id:'situationMap',
                "class":"fa fa-question",
                "aria-hidden":"true",
                "color":'#08ABD5',
                'background':'#888',
                "title":"帮助",
                click:function(){

                    alert("ok");
                }
            }).appendTo("#test");
        });

        var viewer = new Cesium.Viewer('cesiumContainer',{
            baseLayerPicker:true,//图层控制显示

            geocoder:true,//地名查找显示

            timeline:true,//时间线显示

            sceneModePicker:false, //投影方式显示

            navigationHelpButton:false,//帮助键不显示

            homeButton:false//Home键不显示
        });
        //去掉Cesium下角的商标

        viewer._cesiumWidget._creditContainer.style.display="none";
        //buttonControl = new ButtonControl('cesiumContainer', options);
        viewer.scene.globe.enableLighting = true;
        /*选择控件按钮

         that.useNavigationMixin = Cesium.defaultValue(options.useNavigationMixin, true);
         if (that.useNavigationMixin) {
         viewer.extend(Cesium.viewerCesiumNavigationMixin, {});
         }*/
        viewer.extend(Cesium.viewerCesiumNavigationMixin, {});
        /********************************加载实时经纬度坐标********************************/
        position(viewer);
        /*******************************导入json数据********************************/
        Cesium.loadJson('./json/exampleData.json').then(function(data) {

            var baseLineHeight = 10000.0;
            var scene = viewer.scene;
            var entities = viewer.entities;
            var polylineWith = 1;
            var polylineColor = Cesium.Color.GRAY;
            var stationSphereRadius = 700;
            var machineSphereRadius = 350;
            var factorSphereRadius =50;
            var stationSphereColor = Cesium.Color.BLUE.withAlpha(0.8);
            var machineSphereColor = Cesium.Color.YELLOW.withAlpha(0.8);
            //  var factorSphereColor = Cesium.Color.LIGHTSKYBLUE.withAlpha(0.5);
            var factorSphereColor = Cesium.Color.fromRandom();
            var heightScaleForNearStation = 2;

            //计算每一个factor的运动轨迹的点

            var start = Cesium.JulianDate.fromDate(new Date(2017,9,30,12));

            var stop = Cesium.JulianDate.addHours(start,360,new Cesium.JulianDate());
            viewer.clock.startTime = start.clone();
            viewer.clock.stopTime = stop.clone();
            viewer.clock.currentTime = start.clone();
            viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
            viewer.clock.mutiplier = 60;
            viewer.timeline.zoomTo(start,stop);

            for (var i=0;i<data.length;i++)
            {
                if( data[i]["stationID"]===2|| data[i]["stationID"]===6){
                    stationLineHeight = (i+5)*baseLineHeight/20+1800;

                }else{
                    stationLineHeight = (i+5)*baseLineHeight/20;
                }


                var lat = data[i]["Latitude"];
                var log = data[i]["Logitude"];


                /*     var extent = Cesium.Rectangle.fromDegrees(100.334056, 3.522957,101.586551, 38.203119);
                     Cesium.Camera.DEFAULT_VIEW_RECTANGLE = extent;
                     Cesium.Camera.DEFAULT_VIEW_FACTOR = 0;
                     viewer.camera.setView({
                         destination: extent
                     });

        */
                var surfacePosition = Cesium.Cartesian3.fromDegrees(log,lat,0);
                var heightPosition = Cesium.Cartesian3.fromDegrees(log, lat, stationLineHeight);

                var positions = new Cesium.ConstantProperty([surfacePosition, heightPosition]);

                var stationNodeLine = viewer.entities.add({
                    name:"stationPolyline",
                    polyline:{
                        positions:positions,
                        width:polylineWith,
                        material:new Cesium.ColorMaterialProperty(polylineColor)
                    }
                });
                // stationNodeLine.orientation = new Cesium.ConstantProperty(Cesium.Transforms.headingPitchRollQuaternion(heightPosition, new Cesium.HeadingPitchRoll(heading,pitch,roll)));
                var stationNode = viewer.entities.add({
                    name:"stationSphere"+data[i]["stationName"],
                    position:heightPosition,
                    ellipsoid:{
                        radii:new Cesium.Cartesian3(stationSphereRadius,stationSphereRadius,stationSphereRadius),
                        outline:false,
                        material:stationSphereColor
                    }
                });
                //Add the entity to the collection.
                // entities.add(entity);
                // stationNode.orientation = new Cesium.ConstantProperty(Cesium.Transforms.headingPitchRollQuaternion(heightPosition, new Cesium.HeadingPitchRoll(heading,pitch,roll)));

                for (var j=0;j<data[i]["list"].length;j++){
                    //控制仪器节点

                    var degreeInterval = Cesium.Math.toRadians(360)/data[i]["list"].length;

                    var radians = degreeInterval*j;

                    var startPosition = heightPosition;
                    var machineHeight = 1000;

                    //var endPosition = Cesium.Cartesian3.fromDegrees(log+, lat, 2*baseLineHeight);
                    var radius = 0.01;

                    var endPosition = Cesium.Cartesian3.fromDegrees(log+radius*Math.cos(radians), lat+radius*Math.sin(radians), stationLineHeight+Math.sin(Cesium.Math.toRadians(30))* machineHeight);

                    var machinePositions = new Cesium.ConstantProperty([startPosition, endPosition]);
                    var heading = Cesium.Math.PI_OVER_TWO;
                    var pitch = Cesium.Math.PI_OVER_FOUR;
                    var roll = 0.0;
                    var hpr = new Cesium.HeadingPitchRoll(heading,pitch,roll);



                    var orientation = new Cesium.ConstantProperty(Cesium.Transforms.headingPitchRollQuaternion(startPosition,hpr));
                    //var machinePosition =  Cesium.Cartesian3.fromDegrees(log,lat,750);
                    var machineNodeLine = viewer.entities.add({
                        name:"machinePolyline"+data[i]["list"][j]["machine"],
                        polyline:{
                            positions:machinePositions,
                            width:polylineWith,
                            material:new Cesium.ColorMaterialProperty(polylineColor)
                        }
                    });

                    machineNodeLine.orientation = new Cesium.ConstantProperty(Cesium.Transforms.headingPitchRollQuaternion(Cesium.Cartesian3.fromDegrees(log,lat,500),hpr));
                    var scale = 0.5;
                    var machineNode = viewer.entities.add({
                        name:"machineSphere"+data[i]["list"][j]["machine"],
                        position: endPosition,
                        //orientation:orientation,
                        ellipsoid: {
                            radii: new Cesium.Cartesian3(machineSphereRadius, machineSphereRadius, machineSphereRadius),
                            outline: false,
                            material: machineSphereColor
                        }

                    });

                    for (var k=0;k<data[i]["list"][j]["machineData"].length;k++){

                        var property = computeCircularFlight(log+radius*Math.cos(radians), lat+radius*Math.sin(radians),  stationLineHeight+Math.sin(Cesium.Math.toRadians(30))* machineHeight);
                        //  alert(property);

                        var factorEntity = viewer.entities.add({

                            //设置entity生存时间与
                            availability : new Cesium.TimeIntervalCollection([new Cesium.TimeInterval({
                                start : start,
                                stop : stop
                            })]),

                            //Use our computed positions
                            position : property,

                            //Automatically compute orientation based on position movement.
                            orientation : new Cesium.VelocityOrientationProperty(property),

                            //Load the Cesium plane model to represent the entity
                            ellipsoid: {
                                radii: new Cesium.Cartesian3(factorSphereRadius,factorSphereRadius, factorSphereRadius),
                                outline: false,
                                material:  Cesium.Color.fromRandom()
                            }
                            /*
                            ,

                            //Show the path as a pink line sampled in 1 second increments.
                            path : {
                                resolution : 1,
                                material : new Cesium.PolylineGlowMaterialProperty({
                                    glowPower : 0.1,
                                    color : Cesium.Color.YELLOW
                                }),
                                width : 1
                            }
                            */
                        });

                        factorEntity.position.setInterpolationOptions({
                            interpolationDegree : 2,
                            interpolationAlgorithm : Cesium.LagrangePolynomialApproximation
                        });

                        /*
                        var Pai = Cesium.Math.PI;
                        var factorNode;

                        var factorSphereRadiusPlus =100;


                        //产生一个在0-2派之间的随机角度，控制高度角
                        var factorSpheres_randomAlpha = Cesium.Math.randomBetween(-1,1)*Pai;



                        //产生一个在0-派之间的随机角度控制平面间的旋转
                        var factorSpheres_randomBeta = Cesium.Math.nextRandomNumber()*Pai*2;
                        var factorSpheres_Lineradius = 0.01;
                        var factorNode_log = log+radius*Math.cos(radians)+factorSpheres_Lineradius*Math.cos(factorSpheres_randomAlpha)*Math.sin(factorSpheres_randomBeta);
                        var factorNode_lat = lat+radius*Math.sin(radians)+factorSpheres_Lineradius*Math.cos(factorSpheres_randomAlpha)*Math.cos(factorSpheres_randomBeta);
                        var factorNode_height = stationLineHeight*(Math.sin(Cesium.Math.toRadians(35))+0.8)+Math.sin(factorSpheres_randomAlpha)*1200;

                        var factorNode_endFactorPosition = Cesium.Cartesian3.fromDegrees( factorNode_log,factorNode_lat,factorNode_height);

                        var startFactorPosition = endPosition;
                        var factorDegreeInterval = Cesium.Math.toRadians(360)/data[i]["list"][j]["machineData"].length;
                        var factorRadians = factorDegreeInterval*k;
                        // var endFactorPosition = Cesium.Cartesian3.fromDegrees(log+radius*Math.cos(radians), lat+radius*Math.sin(radians),baseLineHeight*(2));
                        //var endFactorPosition = Cesium.Cartesian3.fromDegrees(log+radius*Math.cos(radians)+scale*radius*Math.cos(factorRadians), lat+radius*Math.sin(radians)+scale*radius*Math.sin(factorRadians),factorHeight);
                        //var factorPositions = new Cesium.ConstantProperty([startFactorPosition, factorNode_endFactorPosition]);


                              // var factorNodeLine = viewer.entities.add({
                                 //  name:"factorPolyline"+data[i]["list"][j]["machineData"][k]["data"][0]["value"],
                                 //  polyline:{
                                  //     positions:factorPositions,
                                  //     width:polylineWith,
                                  //     material:new Cesium.ColorMaterialProperty(polylineColor)
                                 //  }
                              // });

                        factorNode = viewer.entities.add({
                            name:"factorSphere"+data[i]["list"][j]["machineData"][k]["data"][0]["value"],
                            position: factorNode_endFactorPosition,
                            orientation:orientation,
                            ellipsoid: {
                                radii: new Cesium.Cartesian3(factorSphereRadius,factorSphereRadius, factorSphereRadius),
                                outline: false,
                                material:  Cesium.Color.fromRandom()
                            }

                        });
                        if (data[i]["list"][j]["machineData"][k]["data"][0]["warningGrade"]==="5"){
                            factorNodeWarning = viewer.entities.add({
                                name:"factorSphereWarning"+data[i]["list"][j]["machineData"][k]["data"][0]["value"],
                                position: factorNode_endFactorPosition,
                                orientation:orientation,
                                ellipsoid: {
                                    radii: new Cesium.Cartesian3(factorSphereRadius+100,factorSphereRadius+100, factorSphereRadius+100),
                                    outline: false,
                                    material:Cesium.Color.RED.withAlpha(0.3)
                                }

                            });
                        }
                        */
                    }
                }


            }

            function computeCircularFlight(lon, lat, height) {

                var property = new Cesium.SampledPositionProperty();
                //计算标准圆形轨道的9个差值点
                var originalPositionsArray = calculatePositions();

                //对于传进来的仪器位置，随机生成空间旋转圆形轨道的旋转角度
                var randomRotationAngel = generateRandomRotationAngel();

                //返回一个3x3的标准差值点矩阵
                var rotationMatrix = caculateRotationMatrix(randomRotationAngel);

                //计算旋转后的9x3的空间差值点坐标
                var positionsArray = squareMatrixMultiply(originalPositionsArray, rotationMatrix);

                for (var i = 0; i <positionsArray.length; i++) {
                    var time = Cesium.JulianDate.addSeconds(start, i*360/positionsArray.length, new Cesium.JulianDate());
                    var position = Cesium.Cartesian3.fromDegrees(lon + positionsArray[i][0], lat + positionsArray[i][1], height+positionsArray[i][2]*1115);
                    property.addSample(time, position);

                    //Also create a point for each sample we generate.
                    /*viewer.entities.add({
                        position : position,
                        point : {
                            pixelSize : 8,
                            color : Cesium.Color.TRANSPARENT,
                            outlineColor : Cesium.Color.YELLOW,
                            outlineWidth : 3
                        }
                    });
                    */
                }
                return property;
            }

            //随机生成一组绕轴旋转的角度值，分别为Log方向：α，lat方向：β，z方向：γ
            function generateRandomRotationAngel(){
                var α = Cesium.Math.randomBetween(0,1)*Cesium.Math.PI;
                var β= Cesium.Math.randomBetween(0,1)*Cesium.Math.PI;
                var γ = Cesium.Math.randomBetween(0,1)*Cesium.Math.PI;
                var randomRotationAngelArray = new Array(3);
                randomRotationAngelArray[0]=α;
                randomRotationAngelArray[1]=β;
                randomRotationAngelArray[2]=γ;

                return randomRotationAngelArray;
            }
            /*******************************计算factor围绕小球旋转矩阵********************************/
            /*传入随机角度α，β，γ计算其对应旋转矩阵*/
            function caculateRotationMatrix(randomRotationAngelArray){
                var α = randomRotationAngelArray[0];
                var β= randomRotationAngelArray[1];
                var γ = randomRotationAngelArray[2];
                var cosα = Math.cos(α);
                var sinα = Math.sin(α);
                var cosβ = Math.cos(β);
                var sinβ = Math.sin(β);
                var cosγ = Math.cos(γ);
                var sinγ = Math.sin(γ);

                var a1 = cosα*cosγ-cosβ*sinα*sinγ;
                var a2 = sinα*cosγ+cosβ*cosα*sinγ;
                var a3 = sinβ*sinγ;
                var a4 = -cosα*sinγ-cosβ*sinα*cosγ;
                var a5 = -sinα*sinγ+cosβ*cosα*cosγ;
                var a6 = sinβ*cosγ;
                var a7 = sinβ*sinα;
                var a8 = -sinβ*cosα;
                var a9= cosβ;

                var rotationMatrix = new Array(new Array(3), new Array(3), new Array(3));

                rotationMatrix[0][0] = a1;
                rotationMatrix[0][1] = a2;
                rotationMatrix[0][2] = a3;
                rotationMatrix[1][0] = a4;
                rotationMatrix[1][1] = a5;
                rotationMatrix[1][2] = a6;
                rotationMatrix[2][0] = a7;
                rotationMatrix[2][1] = a8;
                rotationMatrix[2][2] = a9;

                return rotationMatrix;
            }

            /*生成在标准坐标系中的9个z轴值为零的均分差值点的坐标，第9个值为起始值，使形成闭合环路*/
            function calculatePositions(){
                var arry = new Array(new Array(3), new Array(3), new Array(3),new Array(3), new Array(3), new Array(3),new Array(3), new Array(3), new Array(3));

                var number = 0.006;
                arry[0][0] = number;
                arry[0][1] = 0;
                arry[0][2] = 0;
                arry[1][0] = Math.sqrt(2)/2*number;
                arry[1][1] = Math.sqrt(2)/2*number;
                arry[1][2] = 0;
                arry[2][0] = 0;
                arry[2][1] = number;
                arry[2][2] = 0;
                arry[3][0] = -Math.sqrt(2)/2*number;
                arry[3][1] = Math.sqrt(2)/2*number;
                arry[3][2] = 0;
                arry[4][0] = -number;
                arry[4][1] = 0;
                arry[4][2] = 0;
                arry[5][0] = -Math.sqrt(2)/2*number;
                arry[5][1] = -Math.sqrt(2)/2*number;
                arry[5][2] = 0;
                arry[6][0] = 0;
                arry[6][1] = -number;
                arry[6][2] = 0;
                arry[7][0] = Math.sqrt(2)/2*number;
                arry[7][1] = -Math.sqrt(2)/2*number;
                arry[7][2] = 0;
                arry[8][0] = number;
                arry[8][1] = 0;
                arry[8][2] = 0;

                return arry;
            }



            function squareMatrixMultiply(A, B) {
                var n = A.length;
                var C = new Array(new Array(3), new Array(3), new Array(3),new Array(3), new Array(3), new Array(3),new Array(3), new Array(3), new Array(3));

                for (var i = 0; i < n; i++) {

                    for (var j = 0; j < A[i].length; j++) {
                        C[i][j]=0;
                        for (var k = 0; k < A[i].length; k++) {


                            C[i][j]+= A[i][k] * B[k][j];
                        }
                    }
                }
                return C;
            }

            function calculateExplosionFlight(lon, lat, height){
                var property = new Cesium.SampledPositionProperty();
                var α = new  Cesium.Math.randomBetween(0,2)*Cesium.Math.PI;
                var β = new  Cesium.Math.randomBetween(-1,1)*Cesium.Math.PI_OVER_TWO;


                for (var i = 0; i <positionsArray.length; i++) {
                    var time = Cesium.JulianDate.addSeconds(start, i*360/positionsArray.length, new Cesium.JulianDate());
                    var position = Cesium.Cartesian3.fromDegrees(lon + positionsArray[i][0], lat + positionsArray[i][1], height+positionsArray[i][2]*1115);
                    property.addSample(time, position);

                    //Also create a point for each sample we generate.
                    /*viewer.entities.add({
                        position : position,
                        point : {
                            pixelSize : 8,
                            color : Cesium.Color.TRANSPARENT,
                            outlineColor : Cesium.Color.YELLOW,
                            outlineWidth : 3
                        }
                    });
                    */
                }
                return property;

            }
//var result = squareMatrixMultiply(calculatePositions(), caculateRotationMatrix());

            viewer.zoomTo(viewer.entities);
        }).otherwise(function(error) {
            alert(error);
        });
        function getDataForHeatMap(){
            var points = [];
            var maxValue = 0,minValue = 0;
            for (var i = currentData.length - 1; i >= 0; i--) {
                var x = currentData[i].lon;
                var y = currentData[i].lat;
                var value = currentData[i].aqiValue;
                maxValue = Math.max(maxValue, value);
                minValue = Math.min(minValue,value);
                points.push({
                    x : x,
                    y : y,
                    value : value
                });
            }
            var data = {max: maxValue, points: points,min : minValue};
            return data;
        }
        function getBoundsForHeatMap(){
            var bounds = {
                north : currentRectangle.north * 180.0 / Math.PI,
                west : currentRectangle.west* 180.0 / Math.PI,
                south : currentRectangle.south* 180.0 / Math.PI,
                east : currentRectangle.east* 180.0 / Math.PI
            };
            return bounds;
        }
        function preToDrawHeatmap(){
            var data = getDataForHeatMap();
            var bounds = getBoundsForHeatMap();

            var provider = createHeatmapImageryProvider(Cesium,{
                data : data,
                bounds : bounds,
                chInstance : CesiumHeatmap
            });
            var layer = viewer.imageryLayers.addImageryProvider(provider);
            viewer.entities.removeAll();
            if (heatLayer != null){
                viewer.imageryLayers.remove(heatLayer);
                heatLayer = layer;
            }else{
                heatLayer = layer;
            }

        };
        function drawHeatmap(){
            var heatLayer = null;

        }
        function taiShiLegendDraw(){

            var data = [
                {'stationID':'1','stationName':'管委会子站',"Latitude":36.54695, "Logitude":101.52028,'warning-level':'高报值','color':'#f56048','WsNum':'4','wfactor':[{'factor-name':'氨气','overValue':'0.98mg'}]},
                {'stationID':'2','stationName':'海纳1号站',"Latitude":36.55809,"Logitude":101.49935,'warning-level':'预警值','color':"#60bdfa",'WsNum':'1','wfactor':[{'factor-name':'甲烷','overValue':'0.11mg'}]},
                {'stationID':'3','stationName':'信禾站',"Latitude":36.55657, "Logitude":101.87368,'warning-level':'预警值','color':'#fbaa1b','WsNum':'2','wfactor':[{'factor-name':'氯气','overValue':'0.32mg'}]},
                {'stationID':'4','stationName':'宜化1号站',"Latitude":36.89864, "Logitude":101.75441,'warning-level':'高报值','color':'#E8D024','WsNum':'4','wfactor':[{'factor-name':'氨气','overValue':'0.98mg'}]},
                {'stationID':'5','stationName':'宜化2号站',"Latitude":36.89525,"Logitude":101.75372,'warning-level':'预警值','color':"#1c71f2",'WsNum':'1','wfactor':[{'factor-name':'甲烷','overValue':'0.11mg'}]},
                {'stationID':'6','stationName':'海纳2号站',"Latitude":36.55789, "Logitude":101.49936,'warning-level':'预警值','color':'#00A67C','WsNum':'2','wfactor':[{'factor-name':'氯气','overValue':'0.32mg'}]},
                {'stationID':'7','stationName':'天泰站',"Latitude":36.51549, "Logitude":101.52896,'warning-level':'高报值','color':'#f56048','WsNum':'4','wfactor':[{'factor-name':'氨气','overValue':'0.98mg'}]},
                {'stationID':'8','stationName':'湟中县子站',"Latitude":36.49424,"Logitude":101.56043,'warning-level':'预警值','color':"#60bdfa",'WsNum':'1','wfactor':[{'factor-name':'甲烷','overValue':'0.11mg'}]},
                {'stationID':'9','stationName':'东区污水厂站',"Latitude":36.58916, "Logitude":101.52756,'warning-level':'预警值','color':'#fbaa1b','WsNum':'2','wfactor':[{'factor-name':'氯气','overValue':'0.32mg'}]},
                {'stationID':'10','stationName':'苏锡子站',"Latitude":36.50519, "Logitude":101.53191,'warning-level':'高报值','color':'#f56048','WsNum':'4','wfactor':[{'factor-name':'氨气','overValue':'0.98mg'}]},
                {'stationID':'11','stationName':'西区污水厂站',"Latitude":36.63168,"Logitude":101.50297,'warning-level':'预警值','color':"#1c71f2",'WsNum':'1','wfactor':[{'factor-name':'甲烷','overValue':'0.11mg'}]},
                {'stationID':'12','stationName':'桂鲁站',"Latitude":36.54012, "Logitude":101.48518,'warning-level':'预警值','color':'#00A67C','WsNum':'2','wfactor':[{'factor-name':'氯气','overValue':'0.32mg'}]}


            ];
            var markers = [];

            for (var i=0;i<data.length;i++){
                var canvas = document.getElementById("cesiumContainer");
                var marker = document.createElement("div");
                marker.className="station-warning-info";
                marker.id = data[i].stationID+"station";
                marker.style.zIndex = 0;
                //marker.lat = data[i].Latitude;
                // marker.log = data[i].Logitude;

                var dot = document.createElement("div");
                dot.className="warning-position-dot";
                dot.innerHTML="●";
                var factorNum = document.createElement("div");
                factorNum.className="warning-factor-number";
                factorNum.innerHTML=data[i].WsNum;
                var stationName = document.createElement("div");
                stationName.className="station-name";
                stationName.innerHTML = data[i].stationName;
                stationName.style.backgroundColor = data[i].color;
                canvas.appendChild(marker);

                marker.appendChild(dot);
                marker.appendChild(factorNum);
                marker.appendChild(stationName);
                var table = document.createElement("table");
                table.className="station-warning-table";
                table.cellSpacing = 1;
                //table.border-collapse = "collapse";
                var thead = document.createElement("thead");
                var trhead=document.createElement("tr");
                var th =document.createElement("th");
                th.className="station-name-head";
                th.innerHTML = data[i].stationName;
                th.style.backgroundColor = data[i].color;
                th.colspan = 2;
                thead.appendChild(trhead);
                trhead.appendChild(th);
                var tbody = document.createElement("tbody");
                tbody.className="warning-info-title";

                for (var p in data[i])
                {
                    if(p!=="color"){
                        if (p!=="wfactor"){

                            var trbody = document.createElement("tr");
                            var td1 = document.createElement("td");
                            td1.innerHTML = p;

                            var td2 = document.createElement("td");
                            td2.innerHTML = data[i][p];
                            trbody.appendChild(td1);
                            trbody.appendChild(td2);
                            tbody.appendChild(trbody);
                        }else{
                            var trFactor = document.createElement("tr");
                            var tdFactor = document.createElement("td");
                            tdFactor.colspan = 2;
                            tdFactor.style.width = '190px';
                            tdFactor.style.textAlign = "center";
                            tdFactor.innerHTML = "预警因子";

                            trFactor.appendChild(tdFactor);
                            tbody.appendChild(trFactor);

                            for (var f in data[i][p]){
                                trFacBody = document.createElement("tr");
                                tdFacBody1 = document.createElement("td");
                                tdFacBody1.innerHTML = data[i][p][f]['factor-name'];
                                tdFacBody2 = document.createElement("td");
                                tdFacBody2.innerHTML = data[i][p][f]['overValue'];

                                trFacBody.appendChild(tdFacBody1);
                                trFacBody.appendChild(tdFacBody2);

                                trFactor.appendChild(trFacBody);
                                tbody.appendChild(trFactor);
                            }

                        }
                    }

                    table.appendChild(thead);
                    table.appendChild(tbody);
                    marker.appendChild(table);
                }
                markers.push(marker);
            }

            var htmlOverlay=[];
            var htmlLogitude=[];
            var htmlLatitude=[];
            var scratch=[];
            var position=[];
            var canvasPosition=[];
            var avalibleWidth = document.body.clientWidth;
            var canvasXBias = avalibleWidth*0.25;
            viewer.scene.preRender.addEventListener(function() {
                for(var i=0;i<data.length;i++){
                    htmlOverlay[i] = markers[i];
                    htmlLogitude[i] = data[i].Logitude;
                    htmlLatitude[i] = data[i].Latitude;
                    scratch[i] = new Cesium.Cartesian2();
                    position[i] = Cesium.Cartesian3.fromDegrees(htmlLogitude[i], htmlLatitude[i]);
                    canvasPosition[i] = viewer.scene.cartesianToCanvasCoordinates(position[i], scratch[i]);
                    if (Cesium.defined(canvasPosition[i])) {
                        htmlOverlay[i].style.top = canvasPosition[i].y + 'px';
                        htmlOverlay[i].style.left = (canvasPosition[i].x+canvasXBias) + 'px';
                    }

                }

            });


            $(".station-warning-info").click(function(){
                var selected = $(this);
                $(this).find(".warning-factor-number,.station-name").hide("fast",function(){
                    selected.find(".station-warning-table,.station-name-head,td").show();

                });
            });
            $(".station-name-head").click(function(){
                var selected = $(this);
                $(this).parents("table").hide("fast",function(){
                    selected.parents("table").siblings("div").show();
                });
            });
        }


        function taiShiLayerClick(){

        };
    </script>
    <script>
        function leftSideBarConf(){
            var scTop = 0,
                //Initial position
                beginH = 0,
                windowWidth = $(window).width(),
                classN,
                num;
            $(window).scroll(function(){
                scTop = $(window).scrollTop();
                beginH = 138;
                switch (scTop){
                    case 600: beginH -= 45;break;
                    case 500: beginH -= 50;break;
                    case 400: beginH -= 55;break;
                    case 300: beginH -= 60;break;
                    case 200: beginH -= 65;break;
                    default : beginH = 138;break;
                }
            });
            $('.side-li > li').hover(
                function(){
                    $(this).find('h3').css({border: 'none'})
                        .end().find('span').css({color: ""});
                    classN = $(this).attr('class');
                    num = classN.substring(2, classN.length);
                    beginH = 50;
                    var parkIndex = ($(this).parent().parent().parent().index()-1)/2;
                    var siteIndex = $(this).index();
                    console.log('PARKINDEX:'+parkIndex);

                    var hidenBoxHeight = $(window).height()/2;
                    var top = function () {
                        var calculatedValue = $('.s_'+num).offset().top-20;
                        if (calculatedValue < 0) {
                            calculatedValue += 20;
                        } else if(calculatedValue+hidenBoxHeight>$(window).height()) {
                            calculatedValue = $(window).height()-hidenBoxHeight-10;
                        }
                        return calculatedValue;
                    };

                    $('.hiden-box').show()
                        .css({
                            left: ($(window).width()/4),
                            top:  top,
                            height: ($(window).height()*0.75)
                        }).animate({width: ($(window).width()/4*3*0.75)}, 100);
                    $('.hiden-box > ').find('h3').css({border: ''})
                    $('.hiden-box > li').hide();
                    $('#hiden-'+num).fadeIn(100);
                    //Detailed Posi tion
                    beginH = 0;
                    console.log('side-li > li - hover-enter');
                },
                function(){
                    $(this).find('h3').css({border: ''})
                        .end().find('span').css({color: ""});
                    $('.hiden-box').hide().css({width: '0'});
                    console.log('side-li > li - hover-exit');
                }
            );
            $('.hiden-box').hover(
                function(){
                    $('.s_'+num).addClass("sideLiHover");
                    $('.s_'+num).find('h3').css({border: 'none'})
                    $(this).show().css({width: $(window).width()/4*3*0.75});
                    console.log('hiden-box-hover-enter');
                },

                function(){
                    $('.s_'+num).removeClass("sideLiHover");

                    $('.s_'+num).css({
                        border: '',
                        borderRight: ''
                    }).find('h3').css({border: ''})
                        .end().find('span').css({color: ""});

                    $(this).animate({
                        width: 0
                    }, 0).hide(0);
                    console.log('hiden-box-hover-exit');
                }
            );
        }

    </script>



    <script>
        function openCity(evt, cityName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(cityName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();
    </script>



</body>
</html>
















